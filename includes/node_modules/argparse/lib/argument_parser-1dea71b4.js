"use strict";function ArgumentParser(r){function t(r){return r}if(!(this instanceof ArgumentParser))return new ArgumentParser(r);var e=this;r=r||{},r.description=r.description||null,r.argumentDefault=r.argumentDefault||null,r.prefixChars=r.prefixChars||"-",r.conflictHandler=r.conflictHandler||"error",ActionContainer.call(this,r),r.addHelp="undefined"==typeof r.addHelp||!!r.addHelp,r.parents=r.parents||[],r.prog=r.prog||Path.basename(process.argv[1]),this.prog=r.prog,this.usage=r.usage,this.epilog=r.epilog,this.version=r.version,this.debug=!0===r.debug,this.formatterClass=r.formatterClass||HelpFormatter,this.fromfilePrefixChars=r.fromfilePrefixChars||null,this._positionals=this.addArgumentGroup({title:"Positional arguments"}),this._optionals=this.addArgumentGroup({title:"Optional arguments"}),this._subparsers=null,this.register("type","auto",t),this.register("type",null,t),this.register("type","int",function(r){var t=parseInt(r,10);if(isNaN(t))throw new Error(r+" is not a valid integer.");return t}),this.register("type","float",function(r){var t=parseFloat(r);if(isNaN(t))throw new Error(r+" is not a valid float.");return t}),this.register("type","string",function(r){return""+r});var n=this.prefixChars.indexOf("-")>-1?"-":this.prefixChars[0];r.addHelp&&this.addArgument([n+"h",n+n+"help"],{action:"help",defaultValue:c.SUPPRESS,help:"Show this help message and exit."}),"undefined"!=typeof this.version&&this.addArgument([n+"v",n+n+"version"],{action:"version",version:this.version,defaultValue:c.SUPPRESS,help:"Show program's version number and exit."}),r.parents.forEach(function(r){if(e._addContainerActions(r),"undefined"!=typeof r._defaults)for(var t in r._defaults)r._defaults.hasOwnProperty(t)&&(e._defaults[t]=r._defaults[t])})}var util=require("util"),format=require("util").format,Path=require("path"),sprintf=require("sprintf-js").sprintf,c=require("./const"),$$=require("./utils"),ActionContainer=require("./action_container"),argumentErrorHelper=require("./argument/error"),HelpFormatter=require("./help/formatter"),Namespace=require("./namespace");util.inherits(ArgumentParser,ActionContainer),ArgumentParser.prototype.addSubparsers=function(r){if(this._subparsers&&this.error("Cannot have multiple subparser arguments."),r=r||{},r.debug=!0===this.debug,r.optionStrings=[],r.parserClass=r.parserClass||ArgumentParser,r.title||r.description?(this._subparsers=this.addArgumentGroup({title:r.title||"subcommands",description:r.description}),delete r.title,delete r.description):this._subparsers=this._positionals,!r.prog){var t=this._getFormatter(),e=this._getPositionalActions(),n=this._mutuallyExclusiveGroups;t.addUsage(this.usage,e,n,""),r.prog=t.formatHelp().trim()}var i=this._popActionClass(r,"parsers"),s=new i(r);return this._subparsers._addAction(s),s},ArgumentParser.prototype._addAction=function(r){return r.isOptional()?this._optionals._addAction(r):this._positionals._addAction(r),r},ArgumentParser.prototype._getOptionalActions=function(){return this._actions.filter(function(r){return r.isOptional()})},ArgumentParser.prototype._getPositionalActions=function(){return this._actions.filter(function(r){return r.isPositional()})},ArgumentParser.prototype.parseArgs=function(r,t){var e,n=this.parseKnownArgs(r,t);return r=n[0],e=n[1],e&&e.length>0&&this.error(format("Unrecognized arguments: %s.",e.join(" "))),r},ArgumentParser.prototype.parseKnownArgs=function(r,t){var e=this;r=r||process.argv.slice(2),t=t||new Namespace,e._actions.forEach(function(r){if(r.dest!==c.SUPPRESS&&!$$.has(t,r.dest)&&r.defaultValue!==c.SUPPRESS){var n=r.defaultValue;"string"==typeof r.defaultValue&&(n=e._getValue(r,n)),t[r.dest]=n}}),Object.keys(e._defaults).forEach(function(r){t[r]=e._defaults[r]});try{var n=this._parseKnownArgs(r,t);return t=n[0],r=n[1],$$.has(t,c._UNRECOGNIZED_ARGS_ATTR)&&(r=$$.arrayUnion(r,t[c._UNRECOGNIZED_ARGS_ATTR]),delete t[c._UNRECOGNIZED_ARGS_ATTR]),[t,r]}catch(r){this.error(r)}},ArgumentParser.prototype._parseKnownArgs=function(r,t){function e(r){return r.getName()}function n(r,n,i){d.push(r);var s=a._getValues(r,n);s!==r.defaultValue&&(A.push(r),l[e(r)]&&l[e(r)].forEach(function(t){if(A.indexOf(t)>=0)throw argumentErrorHelper(r,format('Not allowed with argument "%s".',t.getName()))})),s!==c.SUPPRESS&&r.call(a,t,s,i)}function i(t){for(var e,i,s,u,p=f[t],l=p[0],c=p[1],h=p[2],g=[];;){if(!l)return o.push(r[t]),t+1;if(!h){s=t+1;var d=m.substr(s);i=a._matchArgument(l,d),u=s+i,e=r.slice(s,u),g.push([l,e,c]);break}i=a._matchArgument(l,"A");var A=a.prefixChars;if(!(0===i&&A.indexOf(c[1])<0)){if(1===i){u=t+1,e=[h],g.push([l,e,c]);break}throw argumentErrorHelper(l,sprintf("ignored explicit argument %r",h))}g.push([l,[],c]),c=c[0]+h[0];var _=h.slice(1)||null,v=a._optionStringActions;if(!(Object.keys(v).indexOf(c)>=0))throw argumentErrorHelper(l,sprintf("ignored explicit argument %r",h));l=v[c],h=_}if(g.length<1)throw new Error("length should be > 0");for(var y=0;y<g.length;y++)n.apply(a,g[y]);return u}function s(t){for(var e=m.substr(t),i=a._matchArgumentsPartial(_,e),s=0;s<_.length;s++){var o=_[s],u=i[s];if(void 0!==u){var p=r.slice(t,t+u);t+=u,n(o,p)}}return _=_.slice(i.length),t}var a=this,o=[];null!==this.fromfilePrefixChars&&(r=this._readArgsFromFiles(r));var u,p,l={};this._mutuallyExclusiveGroups.forEach(function(r){r._groupActions.forEach(function(r,t,n){p=e(r),$$.has(l,p)||(l[p]=[]),u=l[p],u.push.apply(u,n.slice(0,t)),u.push.apply(u,n.slice(t+1))})});var f={},h=[];r.forEach(function(t,e){if("--"===t)for(h.push("-");e<r.length;)h.push("A"),e++;else{var n,i=a._parseOptional(t);i?(f[e]=i,n="O"):n="A",h.push(n)}});var g,m=h.join(""),d=[],A=[],_=a._getPositionalActions(),v=0,y=-1;Object.keys(f).forEach(function(r){y=Math.max(y,parseInt(r,10))});for(var E,P;v<=y;){P=null;for(g in f)f.hasOwnProperty(g)&&(g=parseInt(g,10))>=v&&(P=null!==P?Math.min(P,g):g);if(v!==P){if((E=s(v))>v){v=E;continue}v=E}if(!f[v]){var O=r.slice(v,P);o=o.concat(O),v=P}v=i(v)}var x=s(v);o=o.concat(r.slice(x)),_.length>0&&a.error("too few arguments"),a._actions.forEach(function(r){r.required&&d.indexOf(r)<0&&a.error(format('Argument "%s" is required',r.getName()))});var b=!1;return a._mutuallyExclusiveGroups.forEach(function(r){if(r.required&&!(b=r._groupActions.some(function(r){return-1!==A.indexOf(r)}))){var t=[];r._groupActions.forEach(function(r){r.help!==c.SUPPRESS&&t.push(r.getName())}),t=t.join(" ");var e="one of the arguments "+t+" is required";a.error(e)}}),[t,o]},ArgumentParser.prototype._readArgsFromFiles=function(r){var t=this,e=require("fs"),n=[];return r.forEach(function(r){if(t.fromfilePrefixChars.indexOf(r[0])<0)n.push(r);else try{var i=[],s=r.slice(1),a=e.readFileSync(s,"utf8");a=a.trim().split("\n"),a.forEach(function(r){t.convertArgLineToArgs(r).forEach(function(r){i.push(r)}),i=t._readArgsFromFiles(i)}),n.push.apply(n,i)}catch(r){return t.error(r.message)}}),n},ArgumentParser.prototype.convertArgLineToArgs=function(r){return[r]},ArgumentParser.prototype._matchArgument=function(r,t){var e,n=new RegExp("^"+this._getNargsPattern(r)),i=t.match(n);if(!i){switch(r.nargs){case undefined:case null:e="Expected one argument.";break;case c.OPTIONAL:e="Expected at most one argument.";break;case c.ONE_OR_MORE:e="Expected at least one argument.";break;default:e="Expected %s argument(s)"}throw argumentErrorHelper(r,format(e,r.nargs))}return i[1].length},ArgumentParser.prototype._matchArgumentsPartial=function(r,t){function e(r){return r.length}var n,i,s,a,o,u=this,p=[];for(a=r.length;a>0;a--){for(i="",n=r.slice(0,a),o=0;o<n.length;o++)i+=u._getNargsPattern(n[o]);if(i=new RegExp("^"+i),(s=t.match(i))&&s.length>0){s=s.splice(1),p=p.concat(s.map(e));break}}return p},ArgumentParser.prototype._parseOptional=function(r){var t,e,n,i;if(!r)return null;if(this.prefixChars.indexOf(r[0])<0)return null;if(this._optionStringActions[r])return[this._optionStringActions[r],r,null];if(1===r.length)return null;if(r.indexOf("=")>=0&&(e=r.split("=",1)[0],n=r.slice(e.length+1),this._optionStringActions[e]))return t=this._optionStringActions[e],[t,e,n];if(i=this._getOptionTuples(r),i.length>1){var s=i.map(function(r){return r[1]});this.error(format('Ambiguous option: "%s" could match %s.',r,s.join(", ")))}else if(1===i.length)return i[0];return r.match(this._regexpNegativeNumber)&&!this._hasNegativeNumberOptionals.some(Boolean)?null:r.search(" ")>=0?null:[null,r,null]},ArgumentParser.prototype._getOptionTuples=function(r){var t,e,n,i,s=[],a=this.prefixChars;if(a.indexOf(r[0])>=0&&a.indexOf(r[1])>=0){if(r.indexOf("=")>=0){var o=r.split("=",1);t=o[0],e=o[1]}else t=r,e=null;for(i in this._optionStringActions)i.substr(0,t.length)===t&&(n=this._optionStringActions[i],s.push([n,i,e]))}else{if(!(a.indexOf(r[0])>=0&&a.indexOf(r[1])<0))throw new Error(format("Unexpected option string: %s.",r));t=r,e=null;var u=r.substr(0,2),p=r.substr(2);for(i in this._optionStringActions)$$.has(this._optionStringActions,i)&&(n=this._optionStringActions[i],i===u?s.push([n,i,p]):i.substr(0,t.length)===t&&s.push([n,i,e]))}return s},ArgumentParser.prototype._getNargsPattern=function(r){var t;switch(r.nargs){case undefined:case null:t="(-*A-*)";break;case c.OPTIONAL:t="(-*A?-*)";break;case c.ZERO_OR_MORE:t="(-*[A-]*)";break;case c.ONE_OR_MORE:t="(-*A[A-]*)";break;case c.REMAINDER:t="([-AO]*)";break;case c.PARSER:t="(-*A[-AO]*)";break;default:t="(-*"+$$.repeat("-*A",r.nargs)+"-*)"}return r.isOptional()&&(t=t.replace(/-\*/g,""),t=t.replace(/-/g,"")),t},ArgumentParser.prototype._getValues=function(r,t){var e=this;r.nargs!==c.PARSER&&r.nargs!==c.REMAINDER&&(t=t.filter(function(r){return"--"!==r}));var n,i;return 0===t.length&&r.nargs===c.OPTIONAL?"string"==typeof(n=r.isOptional()?r.constant:r.defaultValue)&&(n=this._getValue(r,n),this._checkValue(r,n)):0===t.length&&r.nargs===c.ZERO_OR_MORE&&0===r.optionStrings.length?(n=r.defaultValue||t,this._checkValue(r,n)):1!==t.length||r.nargs&&r.nargs!==c.OPTIONAL?r.nargs===c.REMAINDER?n=t.map(function(t){return e._getValue(r,t)}):r.nargs===c.PARSER?(n=t.map(function(t){return e._getValue(r,t)}),this._checkValue(r,n[0])):(n=t.map(function(t){return e._getValue(r,t)}),n.forEach(function(t){e._checkValue(r,t)})):(i=t[0],n=this._getValue(r,i),this._checkValue(r,n)),n},ArgumentParser.prototype._getValue=function(r,t){var e,n=this._registryGet("type",r.type,r.type);if("function"!=typeof n){var i=format("%s is not callable",n);throw argumentErrorHelper(r,i)}try{e=n(t)}catch(e){var s=null;s="string"==typeof r.type?r.type:r.type.name||r.type.displayName||"<function>";var a=format("Invalid %s value: %s",s,t);throw"<function>"===s&&(a+="\n"+e.message),argumentErrorHelper(r,a)}return e},ArgumentParser.prototype._checkValue=function(r,t){var e=r.choices;if(e){if(("string"==typeof e||Array.isArray(e))&&-1!==e.indexOf(t))return;if("object"==typeof e&&!Array.isArray(e)&&e[t])return;e="string"==typeof e?e.split("").join(", "):Array.isArray(e)?e.join(", "):Object.keys(e).join(", ");var n=format("Invalid choice: %s (choose from [%s])",t,e);throw argumentErrorHelper(r,n)}},ArgumentParser.prototype.formatUsage=function(){var r=this._getFormatter();return r.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups),r.formatHelp()},ArgumentParser.prototype.formatHelp=function(){var r=this._getFormatter();return r.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups),r.addText(this.description),this._actionGroups.forEach(function(t){r.startSection(t.title),r.addText(t.description),r.addArguments(t._groupActions),r.endSection()}),r.addText(this.epilog),r.formatHelp()},ArgumentParser.prototype._getFormatter=function(){return new(0,this.formatterClass)({prog:this.prog})},ArgumentParser.prototype.printUsage=function(){this._printMessage(this.formatUsage())},ArgumentParser.prototype.printHelp=function(){this._printMessage(this.formatHelp())},ArgumentParser.prototype._printMessage=function(r,t){t||(t=process.stdout),r&&t.write(""+r)},ArgumentParser.prototype.exit=function(r,t){t&&(0===r?this._printMessage(t):this._printMessage(t,process.stderr)),process.exit(r)},ArgumentParser.prototype.error=function(r){var t;if(r instanceof Error){if(!0===this.debug)throw r;t=r.message}else t=r;var e=format("%s: error: %s",this.prog,t)+c.EOL;if(!0===this.debug)throw new Error(e);return this.printUsage(process.stderr),this.exit(2,e)},module.exports=ArgumentParser;