"use strict";var format=require("util").format,c=require("./const"),$$=require("./utils"),ActionHelp=require("./action/help"),ActionAppend=require("./action/append"),ActionAppendConstant=require("./action/append/constant"),ActionCount=require("./action/count"),ActionStore=require("./action/store"),ActionStoreConstant=require("./action/store/constant"),ActionStoreTrue=require("./action/store/true"),ActionStoreFalse=require("./action/store/false"),ActionVersion=require("./action/version"),ActionSubparsers=require("./action/subparsers"),argumentErrorHelper=require("./argument/error"),ActionContainer=module.exports=function(t){t=t||{},this.description=t.description,this.argumentDefault=t.argumentDefault,this.prefixChars=t.prefixChars||"",this.conflictHandler=t.conflictHandler,this._registries={},this.register("action",null,ActionStore),this.register("action","store",ActionStore),this.register("action","storeConst",ActionStoreConstant),this.register("action","storeTrue",ActionStoreTrue),this.register("action","storeFalse",ActionStoreFalse),this.register("action","append",ActionAppend),this.register("action","appendConst",ActionAppendConstant),this.register("action","count",ActionCount),this.register("action","help",ActionHelp),this.register("action","version",ActionVersion),this.register("action","parsers",ActionSubparsers),this._getHandler(),this._actions=[],this._optionStringActions={},this._actionGroups=[],this._mutuallyExclusiveGroups=[],this._defaults={},this._regexpNegativeNumber=new RegExp("^[-]?[0-9]*\\.?[0-9]+([eE][-+]?[0-9]+)?$"),this._hasNegativeNumberOptionals=[]},ArgumentGroup=require("./argument/group"),MutuallyExclusiveGroup=require("./argument/exclusive");ActionContainer.prototype.register=function(t,i,r){this._registries[t]=this._registries[t]||{},this._registries[t][i]=r},ActionContainer.prototype._registryGet=function(t,i,r){return arguments.length<3&&(r=null),this._registries[t][i]||r},ActionContainer.prototype.setDefaults=function(t){t=t||{};for(var i in t)$$.has(t,i)&&(this._defaults[i]=t[i]);this._actions.forEach(function(i){$$.has(t,i.dest)&&(i.defaultValue=t[i.dest])})},ActionContainer.prototype.getDefault=function(t){var i=$$.has(this._defaults,t)?this._defaults[t]:null;return this._actions.forEach(function(r){r.dest===t&&$$.has(r,"defaultValue")&&(i=r.defaultValue)}),i},ActionContainer.prototype.addArgument=function(t,i){if(t=t,i=i||{},"string"==typeof t&&(t=[t]),!Array.isArray(t))throw new TypeError("addArgument first argument should be a string or an array");if("object"!=typeof i||Array.isArray(i))throw new TypeError("addArgument second argument should be a hash");if(!t||1===t.length&&this.prefixChars.indexOf(t[0][0])<0){if(t&&i.dest)throw new Error("dest supplied twice for positional argument");i=this._getPositional(t,i)}else i=this._getOptional(t,i);if("undefined"==typeof i.defaultValue){var r=i.dest;$$.has(this._defaults,r)?i.defaultValue=this._defaults[r]:"undefined"!=typeof this.argumentDefault&&(i.defaultValue=this.argumentDefault)}var e=this._popActionClass(i);if("function"!=typeof e)throw new Error(format('Unknown action "%s".',e));var n=new e(i),o=this._registryGet("type",n.type,n.type);if("function"!=typeof o)throw new Error(format('"%s" is not callable',o));return this._addAction(n)},ActionContainer.prototype.addArgumentGroup=function(t){var i=new ArgumentGroup(this,t);return this._actionGroups.push(i),i},ActionContainer.prototype.addMutuallyExclusiveGroup=function(t){var i=new MutuallyExclusiveGroup(this,t);return this._mutuallyExclusiveGroups.push(i),i},ActionContainer.prototype._addAction=function(t){var i=this;return this._checkConflict(t),this._actions.push(t),t.container=this,t.optionStrings.forEach(function(r){i._optionStringActions[r]=t}),t.optionStrings.forEach(function(t){t.match(i._regexpNegativeNumber)&&(i._hasNegativeNumberOptionals.some(Boolean)||i._hasNegativeNumberOptionals.push(!0))}),t},ActionContainer.prototype._removeAction=function(t){var i=this._actions.indexOf(t);i>=0&&this._actions.splice(i,1)},ActionContainer.prototype._addContainerActions=function(t){function i(t){return t.getName()}var r={};this._actionGroups.forEach(function(t){if(r[t.title])throw new Error(format('Cannot merge actions - two groups are named "%s".',t.title));r[t.title]=t});var e={};t._actionGroups.forEach(function(t){r[t.title]||(r[t.title]=this.addArgumentGroup({title:t.title,description:t.description})),t._groupActions.forEach(function(n){e[i(n)]=r[t.title]})},this);var n;t._mutuallyExclusiveGroups.forEach(function(t){n=this.addMutuallyExclusiveGroup({required:t.required}),t._groupActions.forEach(function(t){e[i(t)]=n})},this),t._actions.forEach(function(t){var r=i(t);e[r]?e[r]._addAction(t):this._addAction(t)})},ActionContainer.prototype._getPositional=function(t,i){if(Array.isArray(t)&&(t=t[0]),i.required)throw new Error('"required" is an invalid argument for positionals.');return i.nargs!==c.OPTIONAL&&i.nargs!==c.ZERO_OR_MORE&&(i.required=!0),i.nargs===c.ZERO_OR_MORE&&"undefined"==typeof i.defaultValue&&(i.required=!0),i.dest=t,i.optionStrings=[],i},ActionContainer.prototype._getOptional=function(t,i){var r=this.prefixChars,e=[],n=[];t.forEach(function(t){if(r.indexOf(t[0])<0)throw new Error(format('Invalid option string "%s": must start with a "%s".',t,r));e.push(t),t.length>1&&r.indexOf(t[1])>=0&&n.push(t)});var o=i.dest||null;if(delete i.dest,!o){var s=n.length?n[0]:e[0];if(o=$$.trimChars(s,this.prefixChars),0===o.length)throw new Error(format('dest= is required for options like "%s"',e.join(", ")));o=o.replace(/-/g,"_")}return i.dest=o,i.optionStrings=e,i},ActionContainer.prototype._popActionClass=function(t,i){i=i||null;var r=t.action||i;return delete t.action,this._registryGet("action",r,r)},ActionContainer.prototype._getHandler=function(){var t=this.conflictHandler,i="_handleConflict"+$$.capitalize(t),r=this[i];if(void 0===r){var e="invalid conflict resolution value: "+t;throw new Error(e)}return r},ActionContainer.prototype._checkConflict=function(t){var i=this._optionStringActions,r=[];if(t.optionStrings.forEach(function(t){var e=i[t];void 0!==e&&r.push([t,e])}),r.length>0){this._getHandler().call(this,t,r)}},ActionContainer.prototype._handleConflictError=function(t,i){var r=i.map(function(t){return t[0]});throw r=r.join(", "),argumentErrorHelper(t,format("Conflicting option string(s): %s",r))},ActionContainer.prototype._handleConflictResolve=function(t,i){var r=this;i.forEach(function(t){var i=t[0],e=t[1],n=e.optionStrings.indexOf(i);n>=0&&e.optionStrings.splice(n,1),delete r._optionStringActions[i],0===e.optionStrings.length&&e.container._removeAction(e)})};